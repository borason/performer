dist: trusty
language: cpp
compiler: gcc
notifications:
  email: false
env:
  global:
    # EM_USE_GLOBAL_CACHE=1 tells emscripten to use precompiled libraries from
    # the emscripten-libs-asmjs package. This speeds up the build significantly.
    - EM_USE_GLOBAL_CACHE=1
before_install:
 - sudo apt-get install libasound2-dev
jobs:
  include:
    - stage: Hardware Platform (STM32)
      script:
      - make setup_stm32 && (cd build/stm32/debug && make) && (cd build/stm32/release && make) && make deploy
      # Deploy to github releases
      deploy:
        provider: releases
        api_key:
          secure: "gf6iPMxWpPAWpqXpLQB7723Z4zDYh9lIEG/4ZNzzdj2U0euDldjfXo3jjNINkf2E+1uflfge02d3uFqAfyvxFevqYuSubRimstNrYIXqEKGGONN4OyMUBrAtyQnTetkHGxO2PrroovpvTJWuWa1DB0vGdbeziy1IbtY7HVStBI4id5W97Nd6pWDkbbHVFlx5yeSA153MPo5pCJpd2bxMcRGYcSrLMwxmQmoHxawjK/TuuAKh+HfNLvlQE8aaNSIr2+3Ys1rwm94fHM/PVZVBCwaVJRNzNX/0IxJ1yQpQdRyLY7ez6tLFBnhTxXc9RMIivg/gqUEn3CEHD589FRSkWpQawcjV19jPTy9D6eL5dlcGQ9QHy7TPfnfpx6eoZxERDDJH2wwJL2Nk46mtY6tOYG5Ywr37QWSlDyKYgfEY/hcyMONYmYluxH21Cu9HjEL2ck9/b86CSKCkyzkaINvLsEeylwDgR/mosxMfhb+MAwl8STWBL42FsX1APRdQR6KJblki8IuXyswlAI9mukch3s2J3j8CoU+bu/Cam0ZKcwPui5EjL67DPLMB23qcprTdbL7/a39LiWnR3cJbbomnLp8A+/MOVlR0QFbLay7Bv3qSYe+BASLkFIQPd97Fr36thjaIvG3nj8e3HIN4Te1NjS6tLlPTwtS8L6Bi3mEeD7Y="
        file_glob: true
        file: build/deploy/**/*
        skip_cleanup: true
    - stage: Simulation Platform (Linux)
      script:
      # Simulation target requires recent versions of SDL2, SDL2_image and SDL2_ttf not available as packages
      - wget https://www.libsdl.org/release/SDL2-2.0.7.tar.gz
      - tar -xf SDL2-2.0.7.tar.gz
      - (cd SDL2-2.0.7 && ./configure && make && sudo make install)
      - wget https://www.libsdl.org/projects/SDL_image/release/SDL2_image-2.0.2.tar.gz
      - tar -xf SDL2_image-2.0.2.tar.gz
      - (cd SDL2_image-2.0.2 && ./configure --disable-png && make && sudo make install)
      - wget https://www.libsdl.org/projects/SDL_ttf/release/SDL2_ttf-2.0.14.tar.gz
      - tar -xf SDL2_ttf-2.0.14.tar.gz
      - (cd SDL2_ttf-2.0.14 && ./configure && make && sudo make install)
      - make setup_sim && (cd build/sim/debug && make) && (cd build/sim/release && make)
    - stage: Simulation Platform (WebAssembly)
      script:
      # Download and verify alpine-chroot-install script
      - wget https://raw.githubusercontent.com/alpinelinux/alpine-chroot-install/v0.6.0/alpine-chroot-install
          && echo 'a827a4ba3d0817e7c88bae17fe34e50204983d1e  alpine-chroot-install' | sha1sum -c
      # Install Alpine Linux into /alpine and prepare there a chroot environment;
      # add testing repository and install packages for Emscripten.
      - sudo sh alpine-chroot-install -b v3.6
          -r 'https://nl.alpinelinux.org/alpine/edge/testing'
          -p 'emscripten emscripten-libs-wasm binaryen closure-compiler make cmake'
          -k 'CI TRAVIS_.* EM_.*'
      # Setup a script to run in chroot for emscripten build
      - printf '#!/bin/sh\nexport EMSCRIPTEN=/usr/share/emscripten\nmake setup_www\n(cd build/sim/www && make)' > build-www.sh
      - chmod a+x build-www.sh
      # Build
      - /alpine/enter-chroot -u $USER ./build-www.sh
      after_success:
      - make deploy-simulator
      env:
        global:
          secure: "gf6iPMxWpPAWpqXpLQB7723Z4zDYh9lIEG/4ZNzzdj2U0euDldjfXo3jjNINkf2E+1uflfge02d3uFqAfyvxFevqYuSubRimstNrYIXqEKGGONN4OyMUBrAtyQnTetkHGxO2PrroovpvTJWuWa1DB0vGdbeziy1IbtY7HVStBI4id5W97Nd6pWDkbbHVFlx5yeSA153MPo5pCJpd2bxMcRGYcSrLMwxmQmoHxawjK/TuuAKh+HfNLvlQE8aaNSIr2+3Ys1rwm94fHM/PVZVBCwaVJRNzNX/0IxJ1yQpQdRyLY7ez6tLFBnhTxXc9RMIivg/gqUEn3CEHD589FRSkWpQawcjV19jPTy9D6eL5dlcGQ9QHy7TPfnfpx6eoZxERDDJH2wwJL2Nk46mtY6tOYG5Ywr37QWSlDyKYgfEY/hcyMONYmYluxH21Cu9HjEL2ck9/b86CSKCkyzkaINvLsEeylwDgR/mosxMfhb+MAwl8STWBL42FsX1APRdQR6KJblki8IuXyswlAI9mukch3s2J3j8CoU+bu/Cam0ZKcwPui5EjL67DPLMB23qcprTdbL7/a39LiWnR3cJbbomnLp8A+/MOVlR0QFbLay7Bv3qSYe+BASLkFIQPd97Fr36thjaIvG3nj8e3HIN4Te1NjS6tLlPTwtS8L6Bi3mEeD7Y="
